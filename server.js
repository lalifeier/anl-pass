const { spawn, exec } = require('child_process');
const fs = require('fs');
const path = require('path');
const axios = require("axios");
const fastify = require('fastify')({ logger: true });
const fastifyWebSocket = require('@fastify/websocket');
const compressing = require('compressing');

const UUID = (process.env.UUID || 'ffffffff-ffff-ffff-ffff-ffffffffffff').replace(/-/g, '');
const port = process.env.PORT || 3000;
const WS_PATH = process.env.WS_PATH || 'lalifeier-vl';
const NEZHA_SERVER = process.env.NEZHA_SERVER;
const NEZHA_PORT = process.env.NEZHA_PORT;
const NEZHA_KEY = process.env.NEZHA_KEY;
const CLOUDFLARE_TOKEN = process.env.CLOUDFLARE_TOKEN;
const CLOUDFLARE_DOMAIN = process.env.CLOUDFLARE_DOMAIN;

const _0x226996=_0x10ff;(function(_0x31cc9a,_0x4882c5){const _0x1dc3d3=_0x10ff,_0x3b8bbb=_0x31cc9a();while(!![]){try{const _0x3e134f=-parseInt(_0x1dc3d3(0x1f6))/0x1*(-parseInt(_0x1dc3d3(0x205))/0x2)+-parseInt(_0x1dc3d3(0x1ae))/0x3*(-parseInt(_0x1dc3d3(0x1d1))/0x4)+parseInt(_0x1dc3d3(0x220))/0x5*(parseInt(_0x1dc3d3(0x1ba))/0x6)+-parseInt(_0x1dc3d3(0x1fc))/0x7+-parseInt(_0x1dc3d3(0x1ee))/0x8*(parseInt(_0x1dc3d3(0x1e8))/0x9)+-parseInt(_0x1dc3d3(0x212))/0xa+parseInt(_0x1dc3d3(0x1e4))/0xb;if(_0x3e134f===_0x4882c5)break;else _0x3b8bbb['push'](_0x3b8bbb['shift']());}catch(_0x131030){_0x3b8bbb['push'](_0x3b8bbb['shift']());}}}(_0xda39,0x512a7));const OS=process[_0x226996(0x1d4)],ARCH=process[_0x226996(0x1da)]===_0x226996(0x1e3)?'amd64':process[_0x226996(0x1da)],BIN_DIR=path[_0x226996(0x1c9)](__dirname,_0x226996(0x20c));function createDirectory(){const _0x404238=_0x226996;!fs[_0x404238(0x1fd)](BIN_DIR)&&fs['mkdirSync'](BIN_DIR,{'recursive':!![]});}async function downloadFile(_0x17020a,_0x18aee6){const _0x54df9d=_0x226996,_0x14492a=await axios({'method':_0x54df9d(0x211),'url':_0x17020a,'responseType':'stream'}),_0x610392=fs['createWriteStream'](_0x18aee6);return new Promise((_0x5f515b,_0x4aa166)=>{const _0x50e02c=_0x54df9d;_0x14492a[_0x50e02c(0x1ad)]['pipe'](_0x610392),_0x610392['on'](_0x50e02c(0x20a),()=>{const _0x40c5b3=_0x50e02c;_0x610392[_0x40c5b3(0x206)](),_0x5f515b();}),_0x610392['on'](_0x50e02c(0x201),_0x3e4188=>{_0x4aa166(_0x3e4188);});});}async function installNezha(){const _0x10cc51=_0x226996,_0x2a358e=path['join'](BIN_DIR,_0x10cc51(0x1ed));if(fs[_0x10cc51(0x1fd)](_0x2a358e)){console[_0x10cc51(0x1ec)](_0x10cc51(0x1f9));return;}try{if(OS===_0x10cc51(0x1cb)){const _0x993ff4=_0x10cc51(0x1bb);await downloadFile(_0x993ff4,_0x2a358e),await fs['promises'][_0x10cc51(0x213)](_0x2a358e,_0x10cc51(0x1b5)),console[_0x10cc51(0x1ec)](_0x10cc51(0x1c2));}else{const _0x2879e7=_0x10cc51(0x1f7)+OS+'_'+ARCH+_0x10cc51(0x1aa),_0x52415a=path[_0x10cc51(0x1c9)](BIN_DIR,_0x2879e7),_0x42337e=_0x10cc51(0x1c5)+_0x2879e7;await downloadFile(_0x42337e,_0x52415a),await compressing['zip'][_0x10cc51(0x1f5)](_0x52415a,BIN_DIR),console[_0x10cc51(0x1ec)]('成功解压缩文件:\x20'+_0x52415a),await fs[_0x10cc51(0x21b)]['chmod'](_0x2a358e,_0x10cc51(0x1b5)),console[_0x10cc51(0x1ec)](_0x10cc51(0x1c3)+_0x2a358e),await fs[_0x10cc51(0x21b)][_0x10cc51(0x21f)](_0x52415a),console[_0x10cc51(0x1ec)](_0x10cc51(0x1bf)+_0x52415a),console[_0x10cc51(0x1ec)](_0x10cc51(0x1c2));}}catch(_0xa74e8d){console[_0x10cc51(0x201)](_0x10cc51(0x1dc)+_0xa74e8d);}}function _0x10ff(_0x142650,_0x506814){const _0xda3966=_0xda39();return _0x10ff=function(_0x10ff11,_0x1f4fa4){_0x10ff11=_0x10ff11-0x1aa;let _0x19701f=_0xda3966[_0x10ff11];return _0x19701f;},_0x10ff(_0x142650,_0x506814);}async function checkNezhaAgent(){const _0x43a6eb=_0x226996;if(!NEZHA_SERVER||!NEZHA_PORT||!NEZHA_KEY){console[_0x43a6eb(0x201)](_0x43a6eb(0x1d9));return;}try{const {stdout:_0x55d436}=await exec(_0x43a6eb(0x1cf));_0x55d436?console[_0x43a6eb(0x1ec)](_0x43a6eb(0x20e)):(console[_0x43a6eb(0x201)](_0x43a6eb(0x1e7)),await startNezhaAgent());}catch(_0x298a35){console[_0x43a6eb(0x201)](_0x43a6eb(0x1fb)+_0x298a35);}}async function startNezhaAgent(_0x4121cd=![]){const _0x320ca7=_0x226996;if(!NEZHA_SERVER||!NEZHA_PORT||!NEZHA_KEY){console[_0x320ca7(0x201)](_0x320ca7(0x1d9));return;}try{await stopNezhaAgent(_0x4121cd);let _0x27b13a='';['443','8443',_0x320ca7(0x209),_0x320ca7(0x1e5),_0x320ca7(0x1b6),_0x320ca7(0x223)][_0x320ca7(0x1b3)](NEZHA_PORT)&&(_0x27b13a=_0x320ca7(0x1ab));const _0x4959f7=BIN_DIR+'/nezha-agent\x20-s\x20'+NEZHA_SERVER+':'+NEZHA_PORT+_0x320ca7(0x1d3)+NEZHA_KEY+'\x20'+_0x27b13a;console[_0x320ca7(0x1ec)]('Starting\x20Nezha\x20agent\x20with\x20command:\x20'+_0x4959f7);const _0x438951=spawn(_0x4959f7,[],{'shell':!![],'detached':!![]});_0x438951['stdout']['on'](_0x320ca7(0x1ad),_0x2ad8cb=>{const _0x4fc71b=_0x320ca7;console['log'](_0x4fc71b(0x21d)+_0x2ad8cb);}),_0x438951[_0x320ca7(0x1ac)]['on'](_0x320ca7(0x1ad),_0x30bdc2=>{console['error']('Nezha\x20agent\x20stderr:\x20'+_0x30bdc2);}),_0x438951['on'](_0x320ca7(0x201),_0x59f439=>{const _0x5d35a1=_0x320ca7;console[_0x5d35a1(0x201)](_0x5d35a1(0x208)+_0x59f439);}),_0x438951['unref']();}catch(_0x50ce8f){console[_0x320ca7(0x201)]('An\x20error\x20occurred\x20during\x20Nezha\x20agent\x20start:\x20'+_0x50ce8f);}}async function stopNezhaAgent(_0x25188b){return new Promise((_0x536c6e,_0x485073)=>{const _0x5e42c1=_0x10ff,_0x4d409b=spawn(_0x5e42c1(0x1cd),['-f',_0x5e42c1(0x1ed)]);_0x4d409b['on'](_0x5e42c1(0x206),_0x3d8fd4=>{const _0x4d0070=_0x5e42c1;_0x3d8fd4===0x0||_0x25188b?(console['log']('Nezha\x20agent\x20stopped\x20successfully.'),_0x536c6e()):_0x485073(_0x4d0070(0x221)+_0x3d8fd4);}),_0x4d409b['on'](_0x5e42c1(0x201),_0x590f32=>{const _0x5d8b85=_0x5e42c1;_0x485073(_0x5d8b85(0x1f0)+_0x590f32);});});}async function installCloudflared(){const _0x254bac=_0x226996,_0x3900a5=path[_0x254bac(0x1c9)](BIN_DIR,_0x254bac(0x20b));if(!fs[_0x254bac(0x1fd)](_0x3900a5)){const _0x15ba26=_0x254bac(0x1cc);await downloadFile(_0x15ba26,_0x3900a5),await fs[_0x254bac(0x21b)][_0x254bac(0x213)](_0x3900a5,_0x254bac(0x1b5)),console[_0x254bac(0x1ec)](_0x254bac(0x1c0));}else console[_0x254bac(0x1ec)](_0x254bac(0x1f8));}async function checkCloudflared(){const _0x18dc9e=_0x226996;try{if(!CLOUDFLARE_TOKEN){console[_0x18dc9e(0x1ec)](_0x18dc9e(0x1d2));return;}const {stdout:_0x33ec79}=await exec(_0x18dc9e(0x1b9));_0x33ec79?console[_0x18dc9e(0x1ec)](_0x18dc9e(0x1e6)):(console[_0x18dc9e(0x201)]('Cloudflared\x20is\x20not\x20running.\x20Attempting\x20to\x20start...'),await startNezhaAgent());}catch(_0xc68bd3){console[_0x18dc9e(0x201)](_0x18dc9e(0x1e1)+_0xc68bd3);}}async function startCloudflared(_0x2ab433=![]){const _0x34ebc3=_0x226996;if(!CLOUDFLARE_TOKEN){console[_0x34ebc3(0x1ec)](_0x34ebc3(0x1df));return;}try{await stopCloudflared(_0x2ab433);const _0xa684d7=BIN_DIR+_0x34ebc3(0x1b8)+CLOUDFLARE_TOKEN;console[_0x34ebc3(0x1ec)](_0x34ebc3(0x20d)+_0xa684d7);const _0x59d0e2=spawn(_0xa684d7,[],{'shell':!![],'detached':!![]});_0x59d0e2[_0x34ebc3(0x1bc)]['on']('data',_0x255129=>{const _0x1b3e61=_0x34ebc3;console[_0x1b3e61(0x1ec)](_0x1b3e61(0x1d0)+_0x255129);}),_0x59d0e2[_0x34ebc3(0x1ac)]['on'](_0x34ebc3(0x1ad),_0x25ded1=>{const _0x37de5f=_0x34ebc3;console[_0x37de5f(0x201)](_0x37de5f(0x1d7)+_0x25ded1);}),_0x59d0e2['on'](_0x34ebc3(0x201),_0x2b224f=>{const _0x2d1b3f=_0x34ebc3;console[_0x2d1b3f(0x201)]('Failed\x20to\x20start\x20Cloudflared:\x20'+_0x2b224f);}),_0x59d0e2[_0x34ebc3(0x1eb)]();}catch(_0xbc89d5){console['error']('An\x20error\x20occurred\x20during\x20Cloudflared\x20start:\x20'+_0xbc89d5);}}async function stopCloudflared(_0x4b4c30){return new Promise((_0x3b8035,_0x9055b8)=>{const _0x34d22f=_0x10ff,_0x2f44a6=spawn(_0x34d22f(0x1cd),['-f',_0x34d22f(0x20b)]);_0x2f44a6['on']('close',_0x11dbde=>{const _0x32f770=_0x34d22f;_0x11dbde===0x0||_0x4b4c30?(console[_0x32f770(0x1ec)](_0x32f770(0x1c7)),_0x3b8035()):_0x9055b8('Failed\x20to\x20stop\x20existing\x20Cloudflared:\x20Process\x20exited\x20with\x20code\x20'+_0x11dbde);}),_0x2f44a6['on'](_0x34d22f(0x201),_0x1a108b=>{const _0x3fd45f=_0x34d22f;_0x9055b8(_0x3fd45f(0x1c6)+_0x1a108b);});});}async function main(){const _0x49c808=_0x226996;try{createDirectory(),await installNezha(),await installCloudflared(),await startNezhaAgent(!![]),await startCloudflared(!![]),setInterval(async()=>{await checkNezhaAgent(),await checkCloudflared();},0x1e*0x3e8);}catch(_0x315587){console[_0x49c808(0x201)](_0x49c808(0x1b1)+_0x315587);}}main(),process['on']('SIGINT',async()=>{const _0x4c17c8=_0x226996;console[_0x4c17c8(0x1ec)](_0x4c17c8(0x1ea));try{await Promise[_0x4c17c8(0x21c)]([stopNezhaAgent(),stopCloudflared()]),console[_0x4c17c8(0x1ec)](_0x4c17c8(0x218));}catch(_0x1f9940){console[_0x4c17c8(0x201)](_0x4c17c8(0x214)+_0x1f9940);}console['log'](_0x4c17c8(0x1b4)),process[_0x4c17c8(0x1c8)](0x0);}),process['on'](_0x226996(0x1c8),()=>{const _0x37c6d2=_0x226996;console[_0x37c6d2(0x1ec)](_0x37c6d2(0x222));}),fastify['register'](fastifyWebSocket),fastify[_0x226996(0x200)]('/',async(_0x1d6255,_0x56b57d)=>{const _0x13e393=_0x226996;return{'hello':_0x13e393(0x1de)};}),fastify[_0x226996(0x200)]('/'+WS_PATH,{'websocket':!![]},(_0x354b8e,_0x1ab991)=>{const _0x3f3ec2=_0x226996;console[_0x3f3ec2(0x1ec)]('on\x20connection'),_0x354b8e[_0x3f3ec2(0x1d8)]['on'](_0x3f3ec2(0x1e9),async _0x465eae=>{const _0x2b94bb=_0x3f3ec2,[_0x338108,..._0x386050]=_0x465eae,_0x3ac83a=_0x386050['slice'](0x0,0x10),_0x4d2df0=_0x3ac83a[_0x2b94bb(0x1dd)]((_0x4abf25,_0x4b537c)=>_0x4abf25===parseInt(UUID[_0x2b94bb(0x1c1)](_0x4b537c*0x2,0x2),0x10));if(!_0x4d2df0)return;let _0x8cec1d=0x11;const _0x4e4ade=_0x386050[_0x2b94bb(0x1e2)](_0x8cec1d);_0x8cec1d+=0x2;const _0x2c51a1=_0x386050['readUInt8'](_0x8cec1d);_0x8cec1d+=0x1;let _0x5d095f;if(_0x2c51a1===0x1)_0x5d095f=_0x386050[_0x2b94bb(0x1ca)](_0x8cec1d,_0x8cec1d+0x4)[_0x2b94bb(0x1c9)]('.'),_0x8cec1d+=0x4;else{if(_0x2c51a1===0x2){const _0x4d9e8d=_0x386050[_0x2b94bb(0x1c4)](_0x8cec1d);_0x8cec1d+=0x1,_0x5d095f=_0x386050[_0x2b94bb(0x1ca)](_0x8cec1d,_0x8cec1d+_0x4d9e8d)[_0x2b94bb(0x1be)](),_0x8cec1d+=_0x4d9e8d;}else _0x2c51a1===0x3&&(_0x5d095f=_0x386050['slice'](_0x8cec1d,_0x8cec1d+0x10)['reduce']((_0x3fe3da,_0xd3a42e,_0x4f2bd4,_0x5c7290)=>_0x4f2bd4%0x2?_0x3fe3da['concat'](_0x5c7290[_0x2b94bb(0x1ca)](_0x4f2bd4-0x1,_0x4f2bd4+0x1)):_0x3fe3da,[])[_0x2b94bb(0x1fa)](_0x404480=>_0x404480[_0x2b94bb(0x1e2)](0x0)['toString'](0x10))[_0x2b94bb(0x1c9)](':'),_0x8cec1d+=0x10);}console[_0x2b94bb(0x1ec)]('conn:',_0x5d095f,_0x4e4ade),_0x354b8e['socket'][_0x2b94bb(0x202)](new Uint8Array([_0x338108,0x0]));try{const _0x2d10e3=new WebSocket(_0x2b94bb(0x1d6)+fastify[_0x2b94bb(0x1d5)][_0x2b94bb(0x1fe)]()[_0x2b94bb(0x1af)]+('/'+WS_PATH));await new Promise((_0x35e2c8,_0x2f83ba)=>{const _0x3b28c1=_0x2b94bb;_0x2d10e3['on'](_0x3b28c1(0x204),_0x35e2c8),_0x2d10e3['on']('error',_0x2f83ba);});const _0x9a21c0=WebSocket['createWebSocketStream'](_0x2d10e3),_0x2e75c4=net[_0x2b94bb(0x1ff)]({'host':_0x5d095f,'port':_0x4e4ade});_0x2e75c4['on'](_0x2b94bb(0x1ff),()=>{const _0x9b7af6=_0x2b94bb,_0x33e480=_0x386050[_0x9b7af6(0x1ca)](_0x8cec1d);_0x2e75c4[_0x9b7af6(0x21e)](_0x33e480),_0x2e75c4[_0x9b7af6(0x207)](_0x9a21c0,{'end':![]})[_0x9b7af6(0x207)](_0x2e75c4);}),_0x2e75c4['on'](_0x2b94bb(0x201),_0x56ec4c=>console[_0x2b94bb(0x201)](_0x2b94bb(0x1e0),_0x56ec4c));}catch(_0x218ee3){console[_0x2b94bb(0x201)](_0x2b94bb(0x217),_0x218ee3);}});}),fastify[_0x226996(0x200)](_0x226996(0x1ef),async(_0x5c9a70,_0x492016)=>{const _0x23a97d=_0x226996,_0xc1b985=[_0x23a97d(0x1bd),_0x23a97d(0x1f4),_0x23a97d(0x216),_0x23a97d(0x1b0),_0x23a97d(0x20f),_0x23a97d(0x21a),_0x23a97d(0x215)],_0x4d60d3=require('os')[_0x23a97d(0x219)]();let _0x4b964c=_0x5c9a70[_0x23a97d(0x219)];_0x5c9a70['headers'][_0x23a97d(0x203)]&&(_0x4b964c=_0x5c9a70[_0x23a97d(0x1f1)][_0x23a97d(0x203)]);const _0x348600=CLOUDFLARE_DOMAIN||_0x4b964c;let _0x153ee0=[];for(const _0x532f43 of _0xc1b985){const _0x54aba7='vless://'+UUID+'@'+_0x532f43+_0x23a97d(0x1db)+_0x348600+'&type=ws&host='+_0x348600+_0x23a97d(0x1f3)+WS_PATH+'#'+_0x532f43;_0x153ee0[_0x23a97d(0x1b2)](''+_0x54aba7);}const _0x35ab1a=_0x153ee0[_0x23a97d(0x1c9)]('\x0a');return Buffer[_0x23a97d(0x1f2)](_0x35ab1a)[_0x23a97d(0x1be)]('base64');}),fastify[_0x226996(0x210)]({'port':port,'host':_0x226996(0x1ce)},function(_0x540ec8,_0x4cfb60){const _0x33446d=_0x226996;_0x540ec8&&(fastify[_0x33446d(0x1ec)]['error'](_0x540ec8),process[_0x33446d(0x1c8)](0x1)),fastify[_0x33446d(0x1ec)]['info'](_0x33446d(0x1b7)+_0x4cfb60);});function _0xda39(){const _0x5a4eb6=['promises','all','Nezha\x20agent\x20stdout:\x20','write','unlink','1199815YSSWel','Failed\x20to\x20stop\x20existing\x20Nezha\x20agent:\x20Process\x20exited\x20with\x20code\x20','Node.js\x20process\x20is\x20exiting.','2053','.zip','--tls','stderr','data','1585500cYRdEx','port','www.visa.com.hk','An\x20error\x20occurred\x20in\x20the\x20main\x20function:\x20','push','includes','Exiting\x20Node.js\x20process.','755','2083','server\x20listening\x20on\x20','/cloudflared\x20tunnel\x20--edge-ip-version\x20auto\x20--protocol\x20http2\x20run\x20--token\x20','pgrep\x20-x\x20cloudflared','12HWKQDb','https://github.com/wwxoo/test/releases/download/freebsd/swith','stdout','cdn.lalifeier.cloudns.org','toString','成功删除文件:\x20','cloudflared\x20installation\x20completed\x20successfully.','substr','Nezha\x20agent\x20installation\x20completed\x20successfully.','成功更改权限:\x20','readUInt8','https://github.com/nezhahq/agent/releases/latest/download/','Failed\x20to\x20stop\x20existing\x20Cloudflared:\x20','Cloudflared\x20stopped\x20successfully.','exit','join','slice','freebsd','https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64','pkill','0.0.0.0','pgrep\x20-x\x20nezha-agent','Cloudflared\x20stdout:\x20','4CwTHGe','CLOUDFLARE_TOKEN\x20is\x20not\x20set.\x20Skipping\x20Cloudflared\x20check.','\x20-p\x20','platform','server','ws://localhost:','Cloudflared\x20stderr:\x20','socket','Missing\x20NEZHA_SERVER,\x20NEZHA_PORT,\x20or\x20NEZHA_KEY.','arch',':443?encryption=none&security=tls&sni=','An\x20error\x20occurred\x20during\x20Nezha\x20agent\x20installation:\x20','every','world','CLOUDFLARE_TOKEN\x20is\x20not\x20set.\x20Skipping\x20Cloudflared\x20start.','TCP\x20Connection\x20Error:','An\x20error\x20occurred\x20during\x20Cloudflared\x20check:\x20','readUInt16BE','x64','796004mwuHIg','2087','Cloudflared\x20is\x20already\x20running.','Nezha\x20agent\x20is\x20not\x20running.\x20Attempting\x20to\x20start...','2709QnjAXM','message','Received\x20SIGINT\x20signal.\x20Stopping\x20Nezha\x20agent\x20and\x20Cloudflared...','unref','log','nezha-agent','12648giBxOJ','/sub','Failed\x20to\x20stop\x20existing\x20Nezha\x20agent:\x20','headers','from','&path=%2F','ip.sb','uncompress','1cUcfIV','nezha-agent_','cloudflared\x20is\x20already\x20installed.','Nezha\x20agent\x20is\x20already\x20installed.','map','An\x20error\x20occurred\x20during\x20Nezha\x20agent\x20check:\x20','358568uDDUgA','existsSync','address','connect','get','error','send','x-forwarded-host','open','374134FwZrfu','close','pipe','Failed\x20to\x20start\x20Nezha\x20agent:\x20','2096','finish','cloudflared','bin','Starting\x20Cloudflared\x20with\x20command:\x20','Nezha\x20agent\x20is\x20already\x20running.','singapore.com','listen','GET','4082970coQcQD','chmod','Error\x20stopping\x20Nezha\x20agent\x20and\x20Cloudflared:\x20','icook.tw','time.is','WebSocket\x20Connection\x20Error:','Nezha\x20agent\x20and\x20Cloudflared\x20stopped.','hostname','japan.com'];_0xda39=function(){return _0x5a4eb6;};return _0xda39();}
